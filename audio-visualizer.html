<!doctype html><html lang="en"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Audio Visualizer</title><style>:root{--bg:#0b0c10;--accent:#6be;--muted:#9aa}html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}.app{display:grid;grid-template-rows:auto 1fr auto;gap:12px;padding:14px;height:100%;box-sizing:border-box}header{display:flex;flex-wrap:wrap;gap:8px;align-items:center}header h1{font-size:16px;margin:0}button,input[type=file],input[type=color]{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:8px 10px;border-radius:8px;color:inherit;cursor:pointer}button:hover{filter:brightness(1.15)}canvas{width:100%;height:100%;display:block;border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,0.6)}#audioList{list-style:none;padding:0;margin:0;max-height:150px;overflow-y:auto;}#audioList li{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;background:#111;padding:6px 10px;border-radius:6px;}.footer{font-size:12px;opacity:0.8;text-align:center}.sliders{display:flex;gap:10px;align-items:center; flex-wrap: wrap;}label{font-size:12px;color:var(--muted)}input[type=range]{width:120px}</style></head><body><div class="app">  <header>    <h1>Audio Visualizer</h1>    <input id="file" type="file" accept="audio/*">    <button id="mic">Use Mic</button>    <button id="play">Play/Pause</button>    <label>Color <input id="color" type="color" value="#6be2ff"></label>    <div class="sliders">      <label>Intensity <input id="intensity" type="range" min="0" max="3" step="0.01" value="1"></label>      <label>Speed <input id="speed" type="range" min="0" max="3" step="0.01" value="1"></label>

      <label>Volume <input id="volume" type="range" min="0" max="200" step="1" value="100"></label>
      <label>Balance <input id="balance" type="range" min="-1" max="1" step="0.01" value="0"></label>
    </div>  </header>
  <main style="position:relative;min-height:0;">    <canvas id="gl"></canvas>  </main>
  <ul id="audioList"></ul>  

  <div class="footer"><span id="status">All settings auto-save in browser. Local audio storage is persistent (up to 32 files).</span></div></div>
<script>
const MAX_AUDIO = 32;
let db, audioCtx, sourceNode, analyser, gainNode, pannerNode, dataArray, audioEl;
let animationId; 

const statusEl = document.getElementById('status');
const defaultStatus = 'All settings auto-save in browser. Local audio storage is persistent (up to 32 files).';

function showStatus(message, isError = false) {
    statusEl.textContent = message;
    statusEl.style.color = isError ? '#f87171' : '#a7f3d0';
    statusEl.style.opacity = '1';

    setTimeout(() => {
        statusEl.textContent = defaultStatus;
        statusEl.style.color = 'inherit';
        statusEl.style.opacity = '0.8';
    }, 3000);
}

function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open("MilkDropDB",1);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains("audios"))
        db.createObjectStore("audios",{keyPath:"id",autoIncrement:true});
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=e=>{
        console.error("IndexedDB Open Error:", e.target.error);
        showStatus("ERROR: Failed to open local database.", true);
        reject(e);
    };
  });
}

function getAllAudios(){
  return new Promise(res=>{
    const tx=db.transaction("audios","readonly");
    const store=tx.objectStore("audios");
    const req=store.getAll();
    req.onsuccess=()=>res(req.result||[]);
  });
}

function addAudio(name,base64){
  getAllAudios().then(audios=>{
    if(audios.length>=MAX_AUDIO){
        console.error("Audio limit reached (32)");
        showStatus("Audio limit reached (32 files). Please delete one before adding a new file.", true);
        return;
    }
    const tx=db.transaction("audios","readwrite");
    const store=tx.objectStore("audios");

    const request = store.add({name,base64});

    tx.oncomplete=()=>{
        showStatus(`Successfully saved audio: ${name}`);
        renderAudioList();
    };
    tx.onerror = (e) => {
        console.error(`Failed to save audio: ${name}`, e.target.error);
        showStatus(`ERROR: Failed to save ${name}. Check console for details.`, true);
    }
  });
}

function deleteAudio(id){
  console.log(`Deleting audio with ID: ${id}`);
  const tx=db.transaction("audios","readwrite");
  tx.objectStore("audios").delete(id);
  tx.oncomplete=()=>{
      showStatus("Audio file deleted.");
      renderAudioList();
  };
}

function clearAll(){
  if (!confirm("Are you sure you want to clear all saved audios?")) return;
  console.log("Clearing all audios.");
  const tx=db.transaction("audios","readwrite");
  tx.objectStore("audios").clear();
  tx.oncomplete=()=>{
      showStatus("All audio files cleared.");
      renderAudioList();
  };
}

const colorPicker=document.getElementById('color');
const intensityControl=document.getElementById('intensity');
const speedControl=document.getElementById('speed'); 
const volumeControl=document.getElementById('volume'); 
const balanceControl=document.getElementById('balance'); 

const saved=JSON.parse(localStorage.getItem('milkdropSettings')||'{}');

colorPicker.value = saved.color || "#6be2ff";
intensityControl.value = saved.intensity || "1";
speedControl.value = saved.speed || "1";
volumeControl.value = saved.volume || "100"; 
balanceControl.value = saved.balance || "0";  

function saveSettings(){
  localStorage.setItem('milkdropSettings',JSON.stringify({
    color:colorPicker.value,
    intensity:intensityControl.value,
    speed:speedControl.value,
    volume:volumeControl.value, 
    balance:balanceControl.value 
  }));
}

function applyAudioSettings() {
    if (gainNode) {

        gainNode.gain.value = parseFloat(volumeControl.value) / 100;
    }
    if (pannerNode) {

        pannerNode.pan.value = parseFloat(balanceControl.value);
    }
}

[colorPicker,intensityControl,speedControl, volumeControl, balanceControl].forEach(e=>e.addEventListener('input',()=>{

    if (e.id === 'balance') {
        let val = parseFloat(balanceControl.value);

        if (Math.abs(val) < 0.05) { 
            balanceControl.value = 0.00;
        }
    }

    saveSettings();
    applyAudioSettings();
}));

const fileInput=document.getElementById('file');
fileInput.addEventListener('change',e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>addAudio(f.name,r.result);
  r.readAsDataURL(f);
});

const audioList=document.getElementById('audioList');

async function renderAudioList(){
  const audios=await getAllAudios();
  audioList.innerHTML='';
  audios.forEach(a=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${a.name}</span>
      <div>
        <button data-id="${a.id}" class="play-btn">Play</button>
        <button data-id="${a.id}" class="delete-btn">Del</button>
      </div>`;

    li.querySelector('.play-btn').addEventListener('click', () => window.playSaved(a.id));
    li.querySelector('.delete-btn').addEventListener('click', () => deleteAudio(a.id));

    audioList.appendChild(li);
  });

  if(audios.length>0){
    const li=document.createElement('li');
    li.style.justifyContent='center';
    const btn=document.createElement('button');
    btn.textContent='Clear All';
    btn.onclick=clearAll;
    li.appendChild(btn);
    audioList.appendChild(li);
  }
}

function ensureAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=1024; 
    dataArray=new Uint8Array(analyser.frequencyBinCount);

    gainNode = audioCtx.createGain();
    pannerNode = audioCtx.createStereoPanner(); 

    applyAudioSettings();
  }
}

function loadAudio(base64){
  if(audioEl){audioEl.pause();audioEl.remove();}
  audioEl=new Audio(base64);
  audioEl.loop=true;
  ensureAudio();

  if(sourceNode)sourceNode.disconnect();

  sourceNode=audioCtx.createMediaElementSource(audioEl);

  sourceNode.connect(analyser);
  analyser.connect(gainNode);
  gainNode.connect(pannerNode);
  pannerNode.connect(audioCtx.destination);

  audioEl.play().catch(e => console.error("Error playing audio:", e));
  startVisualizer();
}

window.playSaved = async function(id) {

    const tx = db.transaction("audios", "readonly");
    const store = tx.objectStore("audios");
    const req = store.get(id);
    req.onsuccess = () => {
        if (req.result) loadAudio(req.result.base64);
    }
}

document.getElementById('mic').onclick=async()=>{
  ensureAudio();
  try {
    const mic=await navigator.mediaDevices.getUserMedia({audio:true});
    if(sourceNode)sourceNode.disconnect();

    sourceNode=audioCtx.createMediaStreamSource(mic);

    sourceNode.connect(analyser); 
    analyser.connect(gainNode);
    gainNode.connect(pannerNode);
    pannerNode.connect(audioCtx.destination); 

    startVisualizer();
  } catch (e) {
    console.error("Could not access microphone:", e);
    showStatus("ERROR: Could not access microphone. Ensure permissions are granted.", true);
  }
};

document.getElementById('play').onclick=()=>{
  if(audioEl){
    audioEl.paused ? audioEl.play().catch(e => console.error("Play error:", e)) : audioEl.pause();
  } else if (audioCtx && audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
};

const canvas=document.getElementById('gl');
const ctx=canvas.getContext('2d');

function resize(){
  canvas.width=canvas.clientWidth;
  canvas.height=canvas.clientHeight;
}
window.onresize=resize;
resize();

function startVisualizer(){
  if(animationId)cancelAnimationFrame(animationId);

  function radialDraw(){
    animationId=requestAnimationFrame(radialDraw);
    if(!analyser)return;

    analyser.getByteFrequencyData(dataArray);

    const color=colorPicker.value;
    const intensity=parseFloat(intensityControl.value)*0.5;

    ctx.fillStyle='rgba(11, 12, 16, 0.2)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const cx=canvas.width/2;
    const cy=canvas.height/2;
    const radius=Math.min(cx,cy)*0.35; 
    const bars=128; 
    const step=(Math.PI*2)/bars; 

    ctx.strokeStyle=color;
    ctx.lineWidth=1.5;
    ctx.shadowColor=color;
    ctx.shadowBlur=10; 

    for(let i=0;i<bars;i++){
      const ampIndex=Math.floor(i*(dataArray.length/bars));
      const amp=dataArray[ampIndex]/255; 
      const barHeight=amp*280*intensity;
      const angle=i*step;

      const startX=cx+Math.cos(angle)*radius;
      const startY=cy+Math.sin(angle)*radius;
      const endX=cx+Math.cos(angle)*(radius+barHeight);
      const endY=cy+Math.sin(angle)*(radius+barHeight);
      ctx.beginPath();
      ctx.moveTo(startX,startY);
      ctx.lineTo(endX,endY);
      ctx.stroke();

      const r_inner=radius*0.6;
      const barHeight_i=amp*80*intensity;
      const endX_i=cx+Math.cos(angle)*(r_inner-barHeight_i);
      const endY_i=cy+Math.sin(angle)*(r_inner-barHeight_i);
      ctx.beginPath();
      ctx.moveTo(cx+Math.cos(angle)*r_inner, cy+Math.sin(angle)*r_inner);
      ctx.lineTo(endX_i,endY_i);
      ctx.stroke();
    }

    ctx.shadowBlur=0; 

    const avgAmp=dataArray.slice(0, 100).reduce((a,b)=>a+b,0)/100/255; 
    ctx.beginPath();
    ctx.arc(cx,cy,radius*0.2+avgAmp*80,0,Math.PI*2);
    ctx.fillStyle=color;
    ctx.globalAlpha=0.7;
    ctx.fill();
    ctx.globalAlpha=1;

    ctx.beginPath();
    ctx.arc(cx, cy, radius*0.2, 0, Math.PI * 2);
    ctx.strokeStyle = color;
    ctx.lineWidth = 1;
    ctx.stroke();
  }
  radialDraw();
}

openDB()
  .then(r => {
    db = r;
    renderAudioList();
  })
  .catch(e => {

    console.error("Initialization failed.");
  });
</script></body></html>
